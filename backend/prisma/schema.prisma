generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int               @id @default(autoincrement())
  email                    String            @unique
  password                 String
  name                     String?
  createdAt                DateTime          @default(now())
  college                  String?
  phone                    String?
  updatedAt                DateTime          @default(now()) @updatedAt
  messagesReceived         Message[]         @relation("ReceiverMessages")
  messagesSent             Message[]         @relation("SenderMessages")
  notificationsAsRequester Notification[]    @relation("RequesterNotifications")
  notifications            Notification[]    @relation("UserNotifications")
  profile                  Profile?
  ridesCreated             Ride[]            @relation("RideCreator")
  rideRequests             RideJoinRequest[]
  rideMessages             RideMessage[]
  rideParticipants         RideParticipant[]
  rideReviews              RideReview[]

  @@map("User")
}

model Profile {
  id        Int     @id @default(autoincrement())
  userId    Int     @unique
  bio       String?
  avatarUrl String?
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Profile")
}

model Ride {
  id             Int               @id @default(autoincrement())
  creatorId      Int
  source         String
  destination    String
  dateTime       DateTime
  seats          Int
  createdAt      DateTime          @default(now())
  status         String            @default("active")
  costPerPerson  Decimal           @db.Decimal(10, 2)
  seatsAvailable Int
  totalCost      Decimal           @db.Decimal(10, 2)
  notifications  Notification[]
  creator        User              @relation("RideCreator", fields: [creatorId], references: [id])
  joinRequests   RideJoinRequest[]
  rideMessages   RideMessage[]
  participants   RideParticipant[]
  reviews        RideReview[]
   sourceLatitude  Float?    // Add this
  sourceLongitude Float?    // Add this
  destLatitude    Float?    // Add this
  destLongitude   Float?    // Add this

  @@map("Ride")
}

model RideJoinRequest {
  id          Int                   @id @default(autoincrement())
  rideId      Int
  requesterId Int
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  status      RideJoinRequestStatus @default(pending)
  requester   User                  @relation(fields: [requesterId], references: [id])
  ride        Ride                  @relation(fields: [rideId], references: [id], onDelete: Cascade)

  @@unique([rideId, requesterId])
  @@index([rideId])
  @@index([requesterId])
  @@map("RideJoinRequest")
}

model RideParticipant {
  id       Int      @id @default(autoincrement())
  rideId   Int
  userId   Int
  joinedAt DateTime @default(now())
  ride     Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id])

  @@unique([rideId, userId])
  @@map("RideParticipant")
}

model RideReview {
  id        Int      @id @default(autoincrement())
  rideId    Int
  userId    Int
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  ride      Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@map("RideReview")
}

model Message {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  content    String
  createdAt  DateTime @default(now())
  receiver   User     @relation("ReceiverMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SenderMessages", fields: [senderId], references: [id])

  @@map("Message")
}

model Notification {
  id          Int              @id @default(autoincrement())
  userId      Int
  message     String
  isRead      Boolean          @default(false)
  createdAt   DateTime         @default(now())
  requesterId Int?
  rideId      Int
  type        NotificationType
  requester   User?            @relation("RequesterNotifications", fields: [requesterId], references: [id])
  ride        Ride             @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([rideId])
  @@index([isRead])
  @@map("Notification")
}

model RideMessage {
  id        Int      @id @default(autoincrement())
  rideId    Int
  userId    Int
  message   String
  createdAt DateTime @default(now())
  ride      Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([rideId])
  @@index([userId])
  @@map("RideMessage")
}

enum RideJoinRequestStatus {
  pending
  accepted
  declined
}

enum NotificationType {
  join_request
  new_ride
  request_accepted
  request_declined
  ride_updated
  ride_cancelled
  participant_joined
  participant_removed
}
